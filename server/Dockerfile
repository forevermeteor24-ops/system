# ⚠️ 改回使用完整的 Node 环境，解决 Slim 版本缺库导致闪退的问题
FROM node:18

WORKDIR /app

# -----------------------------------------------------------
# 1. 优化缓存层 (这步能解决你图一的“重复上传大文件”问题)
# -----------------------------------------------------------
COPY package*.json ./

# 安装所有依赖 (不使用 ci，不使用 omit=dev，确保和本地一致)
RUN npm install

# -----------------------------------------------------------
# 2. 构建源码
# -----------------------------------------------------------
COPY . .

RUN npm run build

# -----------------------------------------------------------
# 3. 启动
# -----------------------------------------------------------
# 再次确认：如果是 NestJS，这里大概率是 main.js
# 如果你的项目是普通 Express，可能是 index.js
# 这里我写了 main.js，如果报错找不到文件，请自行改为 index.js
CMD ["node", "dist/index.js"]